<!DOCTYPE html>
<html>
<head>
    <title>Bridge Spreadsheet View</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Tabulator -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #bridges-table {
            width: 100%;
            height: calc(100vh - 60px);
            margin-bottom: 0px;
            overflow-x: auto;
            position: relative;
            z-index: 1;
        }
        
        .tabulator {
            min-width: 100%;
        }
        
        .controls {
            padding: 10px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 53px;
            z-index: 2000;
            display: flex;
            align-items: center;
            pointer-events: all;
            box-sizing: border-box;
        }

        #addBridgeBtn, #saveBridgeBtn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        #addBridgeBtn {
            background-color: #4CAF50;
        }
        #addBridgeBtn:hover {
            background-color: #45a049;
        }
        #saveBridgeBtn {
            background-color: #2196F3;
        }
        #saveBridgeBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #saveBridgeBtn:hover:not(:disabled) {
            background-color: #1976D2;
        }

        .tabulator .tabulator-cell {
            padding: 8px 15px;  /* Add more padding to cells */
        }
        
        .tabulator .tabulator-header .tabulator-col {
            background-color: transparent;
            padding: 8px 15px;
            color: white;  /* Keep text white for all headers */
        }

        /* Custom header colors - apply only to header cells */
        .tabulator-col.header-bin {
            background-color: #1b524f !important;
        }

        .tabulator-col.header-data  {
            background-color: #00861d !important;
        }

        .tabulator-col.header-input-data {
            background-color: #005813 !important;
        }

        .tabulator-col.header-tracking  {
            background-color: #410f00 !important;
        }

        .tabulator-col.header-field  {
            background-color: #ff6600 !important;
        }

        .tabulator-col.header-complete  {
            background-color: #36008d !important;
        }
        .tabulator-col.header-tltask  {
            background-color: #1178ff !important;
        }
        .tabulator-col.header-atltask  {
            background-color: #ad1b1b !important;
        }
        .tabulator-col.header-statistics  {
            background-color: #292929 !important;
        }

        .tabulator .tabulator-row .tabulator-frozen {

            border-right: 2px solid #ddd !important;
            z-index: 12 !important;
        }

        .tabulator .tabulator-header .tabulator-frozen {
            position: sticky !important;
            left: 0 !important;
            z-index: 13 !important;
            background-color: #1b524f !important; 
        }


        .tabulator .tabulator-row .tabulator-frozen {
            box-shadow: 2px 0px 3px rgba(0,0,0,0.1);
        }



    </style>
</head>
<body>
    <div id="bridges-table"></div>
    <div class="controls">
        <button id="addBridgeBtn">Add New Bridge</button>
        <button id="saveBridgeBtn" disabled>Save Bridge</button>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        let table;
        let isAddingNewBridge = false;

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // Socket.IO update handler
        socket.on('bridge_update', (updatedBridge) => {
            console.log('Bridge update received:', updatedBridge);
            if (table) {
                // Find and update table row
                const row = table.getRows().find(row => row.getData().bin === updatedBridge.bin);
                if (row) {
                    row.update(updatedBridge)
                        .then(() => {
                            console.log('Bridge updated in table');
                            
                            // Only trigger map update if lat/lon changed
                            const oldData = row.getData();
                            if (oldData.lat !== updatedBridge.lat || oldData.lon !== updatedBridge.lon) {
                                // Emit a special event for coordinate updates
                                socket.emit('coordinates_update', {
                                    bin: updatedBridge.bin,
                                    lat: updatedBridge.lat,
                                    lon: updatedBridge.lon
                                });
                            }
                        })
                        .catch(err => console.error('Error updating bridge in table:', err));
                } else {
                    console.warn(`Could not find row for bridge ${updatedBridge.bin}`);
                }
            }
        });

        const DateTime = luxon.DateTime;

        // Create a separate read-only date config
        const readOnlyDateConfig = {
            formatter: function(cell) {
                const value = cell.getValue();
                if (!value) return "";
                try {
                    return DateTime.fromISO(value).toFormat("MM/dd");
                } catch (e) {
                    console.warn(`Invalid date format for value: ${value}`);
                    return value;
                }
            }
            // No editor property - this makes it read-only
        };

        // Keep the original dateConfig for editable date columns
        const dateConfig = {
            formatter: function(cell) {
                const value = cell.getValue();
                if (!value) return "";
                try {
                    return DateTime.fromISO(value).toFormat("MM/dd");
                } catch (e) {
                    console.warn(`Invalid date format for value: ${value}`);
                    return value;
                }
            },
            editor: "date",
            editorParams: {
                inputFormat: "yyyy-MM-dd",
                outputFormat: "yyyy-MM-dd"
            }
        };

        // Define table columns
        const coreColumns = [
            // Bridge Identification (A-J)
            { 
                title: "BIN", 
                field: "bin", 
                headerFilter: "input",
                cssClass: "header-bin",
                frozen: true,
                width: 120,
                headerSort: true,
                formatter: "plaintext"
            },
            { 
                title: "Latitude", 
                field: "lat",
                cssClass: "header-data",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? Number(value).toFixed(8) : "";
                }
            },
            { 
                title: "Longitude", 
                field: "lon",
                cssClass: "header-data",
                formatter: function(cell) {
                    const value = cell.getValue();
                    return value ? Number(value).toFixed(8) : "";
                }
            },
            { title: "Region", field: "region", cssClass: "header-data" },
            { title: "County", field: "county", cssClass: "header-data" },
            { title: "Due Date", field: "due", cssClass: "header-data", ...readOnlyDateConfig },
            { title: "Spans", field: "spans", cssClass: "header-data" },
            { title: "Load Posting", field: "posting", cssClass: "header-data" },
            { title: "Previous GR", field: "prev_gr", editor: "input", cssClass: "header-input-data" },
            { title: "Active Flags", field: "flags", editor: "input", cssClass: "header-input-data" },
            

            // Field Inspection Planning (M-S)
            { title: "Field Date", field: "field_date", editor: "date", cssClass: "header-field", ...dateConfig },
            { title: "Est. Duration", field: "est_duration", editor: "input", cssClass: "header-field" },
            { title: "Special Access", field: "special_access", editor: "input", cssClass: "header-field" },
            { title: "Notes", field: "notes", editor: "textarea", cssClass: "header-field" },
            { title: "NSTM", field: "nstm", editor: "input", cssClass: "header-field" },
            { title: "Special Emphasis", field: "spe", editor: "input", cssClass: "header-field" },
            { title: "Standards", field: "stds", editor: "input", cssClass: "header-field" }
        ];

        const workflowColumns = [
            
            // Folder Tracking (K-L)
            { 
                title: "Folder Received", 
                field: "folder_received", 
                editor: "date",
                cssClass: "header-tracking",
                ...dateConfig
            },
            { 
                title: "Folder Returned", 
                field: "folder_returned", 
                editor: "date",
                cssClass: "header-tracking",
                ...dateConfig
            },


            // Inspection Completion (T-V)
            { 
                title: "Inspection Completed Date", 
                field: "complete_date", 
                editor: "date",
                cssClass: "header-complete",
                ...dateConfig
            },
            { 
                title: "New GR", 
                field: "new_gr", 
                editor: "input",
                cssClass: "header-complete",},
            { 
                title: "Flags Issued", 
                field: "flags_issued", 
                editor: "select",
                cssClass: "header-complete",
                editorParams: {
                    values: ["Yes", "No"]
                }
            },

            // Report Tasks - Inspector (W-Z)
            {
                title: "Report to ATL",
                field: "report_to_atl",
                editor: "date",
                cssClass: "header-tltask",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Report to QC",
                field: "report_to_qc",
                editor: "date",
                cssClass: "header-tltask",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Inventory to QC",
                field: "inventory_qc",
                editor: "date",
                cssClass: "header-tltask",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "LRFCF Submitted",
                field: "lrfcf_submit",
                editor: "date",
                cssClass: "header-tltask",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },

            // QC Review Process (AA-AB)
            {
                title: "QC Comments Received",
                field: "qc_received",
                editor: "date",
                cssClass: "header-tltask",
                formatter: "datetime",
                ...dateConfig
            },
            {
                title: "QC Comments Assigned To",
                field: "qc_assigned",
                editor: "select",
                cssClass: "header-tltask",
                editorParams: {
                    values: ["TL", "ATL"]
                },
                formatter: function(cell) {
                    const value = cell.getValue();
                    if (value === "TL") {
                        cell.getElement().style.backgroundColor = "#4caf50";
                    } else if (value === "ATL") {
                        cell.getElement().style.backgroundColor = "#fff176";
                    }
                    return value;
                }
            },
            {
                title: "QC Comments Addressed",
                field: "qc_addressed",
                cssClass: "header-tltask",
                editor: "date",
                formatter: "datetime",
                ...dateConfig
            },

            // Assistant Tasks (AC-AG)
            {
                title: "Field Sketches Updated",
                field: "update_sketches",
                cssClass: "header-atltask",
                editor: "date",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Standards Updated",
                field: "stds_upload",
                cssClass: "header-atltask",
                editor: "date",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Report Uploaded to BDIS",
                field: "report_to_bdis",
                cssClass: "header-atltask",
                editor: "date",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Files Uploaded to SharePoint",
                field: "sharepoint",
                cssClass: "header-atltask",
                editor: "date",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },
            {
                title: "Tracking Database Updated",
                field: "update_database",
                cssClass: "header-atltask",
                editor: "date",
                formatter: [
                    "datetime",
                    function(cell) {
                        const value = cell.getValue();
                        if (value === "") {
                            cell.getElement().style.backgroundColor = "#4caf50";
                        } else {
                            cell.getElement().style.backgroundColor = "#fff176";
                        }
                        return value;
                    }
                ],
                ...dateConfig
            },

            // Statistics (AH-AP)
            {
                title: "TL Turnaround",
                field: "tl_turnaround",
                cssClass: "header-statistics"
            },
            {
                title: "ATL Turnaround",
                field: "atl_turnaround",
                cssClass: "header-statistics",
            },
            {
                title: "Report to QC",
                field: "rep_to_qc",
                cssClass: "header-statistics",
            },
            {
                title: "LRFCF Turnaround",
                field: "lrfcf_turnaround",
                cssClass: "header-statistics",
            },
        ];


        // Initialize Tabulator
        table = new Tabulator("#bridges-table", {
            columns: [...coreColumns, ...workflowColumns],
            ajaxURL: "/api/bridges",
            
            layout: "fitData",  
            movableColumns: false,
            history: true,
            headerFilterLiveFilter: true,
            responsiveLayout: false,  
            columnCalcs: "both",
            autoResize: false,
            clipboard: "paste",
            clipboardPasteParser: "table",
            clipboardPasteAction: "replace",
            height: "calc(100vh - 70px)",
            columnDefaults: {
                resizable: true,
                tooltip: true,
                widthGrow: 1,
                minWidth: 100

            },
            rowContextMenu: [
                {
                    label: "Delete Bridge",
                    action: function(e, row) {
                        const bridgeData = row.getData();
                        if (!bridgeData.bin) {
                            alert('Invalid bridge selection');
                            return;
                        }

                        if (confirm(`Are you sure you want to delete bridge ${bridgeData.bin}?`)) {
                            fetch(`/api/bridges/${bridgeData.bin}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => Promise.reject(err));
                                }
                                return response.json();
                            })
                            .then(() => {
                                row.delete();
                                console.log(`Bridge ${bridgeData.bin} deleted successfully`);
                                // Emit socket event with proper structure
                                socket.emit('bridge_deleted', {
                                    type: 'delete',
                                    bin: bridgeData.bin
                                });
                            })
                            .catch(error => {
                                console.error('Error deleting bridge:', error);
                                alert(`Failed to delete bridge: ${error.message || 'Unknown error'}`);
                            });
                        }
                    }
                }
            ]
        });

        // Add separate event listener for cell edits
        table.on("cellEdited", function(cell) {
            const rowData = cell.getRow().getData();
            const field = cell.getField();
            const value = cell.getValue();
            const oldValue = cell.getOldValue();

            // Only proceed if value actually changed
            if (value === oldValue) return;

            // Handle new bridge editing (enable save button)
            if (isAddingNewBridge) {
                const row = cell.getRow();
                const data = row.getData();
                
                // Check if we have the minimum required fields
                const hasRequiredFields = data.bin && data.bin.trim() !== '' && 
                                         data.lat && data.lat.toString().trim() !== '' && 
                                         data.lon && data.lon.toString().trim() !== '';
                
                document.getElementById('saveBridgeBtn').disabled = !hasRequiredFields;
                return; // Don't try to update existing bridge
            }

            // Handle existing bridge updates
            // Make sure we have a BIN
            if (!rowData.bin) {
                cell.restoreOldValue();
                alert("Cannot update: No BIN found for this row");
                return;
            }

            console.log(`Attempting to update ${rowData.bin} field ${field} from ${oldValue} to ${value}`);

            // Send PATCH request
            fetch(`/api/bridges/${rowData.bin}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Update successful:', data);
                // Update the row with returned data
                cell.getRow().update(data);
                // Emit socket event
                socket.emit('bridge_update', data);
            })
            .catch(error => {
                console.error('Error updating bridge:', error);
                cell.restoreOldValue();
                alert(`Failed to update: ${error.message}`);
            });
        });

        // Add New Bridge button handler
        document.getElementById('addBridgeBtn').addEventListener('click', () => {
            isAddingNewBridge = true;
            saveBridgeBtn.disabled = false;
            
            // Use addData instead of addRow for better control
            const newBridgeData = {
                bin: "",
                lat: "",
                lon: "",
                region: "",
                county: "",
                due: "",
                spans: "",
                posting: "",
                prev_gr: "",
                flags: "",
                // Add all other fields as empty strings
                field_date: "",
                est_duration: "",
                special_access: "",
                notes: "",
                nstm: "",
                spe: "",
                stds: ""
            };
            
            table.addData([newBridgeData], true) // true adds to top
            .then((rows) => {
                const newRow = rows[0];
                newRow.scrollTo();
                
                // Focus on BIN cell and start editing
                setTimeout(() => {
                    const binCell = newRow.getCell('bin');
                    if (binCell) {
                        binCell.edit();
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Error adding new bridge:', error);
                isAddingNewBridge = false;
                saveBridgeBtn.disabled = true;
            });
        });

        const saveBridgeBtn = document.getElementById('saveBridgeBtn');

        // Save Bridge button handler
        saveBridgeBtn.addEventListener('click', () => {
            const rows = table.getRows();
            const newRow = rows[rows.length - 1]; // Get last row
            const newRowData = newRow.getData();

            // Validate required fields
            const requiredFields = ['bin', 'lat', 'lon'];
            const missingFields = requiredFields.filter(field => 
                !newRowData[field] || String(newRowData[field]).trim() === ''
            );

            if (missingFields.length > 0) {
                alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
                return;
            }

            // Prepare new bridge data
            const newBridge = {
                ...newRowData,
                region: newRowData.region || '',
                county: newRowData.county || '',
                due: newRowData.due || '',
                completed: newRowData.completed || '',
                week: newRowData.week || '',
                flags: newRowData.flags || '',
                flags_info: '',
                posting: newRowData.posting || '',
                posting_info: '',
                access: newRowData.access || '',
                access_info: '',
                spe: newRowData.spe || '',
                stds: newRowData.stds || '',
                field_time: newRowData.field_time || '',
                due_month: newRowData.due_month || '',
                spans: '',
                prev_gr: '',
                issued: ''
            };

            // Post new bridge to API
            fetch('/api/bridges', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newBridge)
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => {
                        throw new Error(err.message || 'Failed to save bridge');
                    });
                }
                return res.json();
            })
            .then(result => {
                console.log('Created new bridge:', result);
                isAddingNewBridge = false; // Reset the flag
                saveBridgeBtn.disabled = true; // Disable save button
                table.setData("/api/bridges")
                    .then(() => {
                        alert('Bridge saved successfully!');
                    });
            })
            .catch(err => {
                console.error('Error creating bridge:', err);
                alert(`Failed to save bridge: ${err.message}`);
            });
        });
    </script>
</body>
</html>